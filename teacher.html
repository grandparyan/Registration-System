<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資訊組報修管理後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Modal的顯示/隱藏動畫效果 */
        .modal-hidden {
            display: none;
        }
        .modal-visible {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-900">報修管理後台</h1>
            <p class="text-md text-gray-600 mt-2">管理、發布與追蹤所有設備報修請求</p>
        </header>
        
        <!-- 訊息提示區 -->
        <div id="toast-message" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden transition-opacity duration-300"></div>


        <!-- 報修項目表格 -->
        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-600">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3">ID</th>
                        <th scope="col" class="px-6 py-3">地點</th>
                        <th scope="col" class="px-6 py-3">問題描述</th>
                        <th scope="col" class="px-6 py-3">報修者</th>
                        <th scope="col" class="px-6 py-3">狀態 / 學生人數</th>
                        <th scope="col" class="px-6 py-3 text-center">操作</th>
                    </tr>
                </thead>
                <tbody id="report-table-body">
                    <!-- 資料將由 JavaScript 動態載入 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- "發布任務" 用的 Modal 彈出視窗 -->
    <div id="publish-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <h3 class="text-2xl font-semibold text-center mb-6">發布為學生任務</h3>
            <form id="publish-form">
                <input type="hidden" id="publish-report-id">
                <div class="mb-6">
                    <label for="required_students" class="block text-sm font-medium text-gray-700 mb-2">請輸入需要的學生人數：</label>
                    <input type="number" id="required_students" name="required_students" min="1" value="1" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div class="flex justify-center space-x-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition">確認發布</button>
                    <button type="button" id="cancel-publish" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition">取消</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        const tableBody = document.getElementById('report-table-body');
        const publishModal = document.getElementById('publish-modal');
        const publishForm = document.getElementById('publish-form');
        const cancelPublishBtn = document.getElementById('cancel-publish');
        const reportIdInput = document.getElementById('publish-report-id');
        const requiredStudentsInput = document.getElementById('required_students');
        const toastMessage = document.getElementById('toast-message');

        /**
         * 顯示短暫的提示訊息 (Toast)
         * @param {string} message - 要顯示的訊息
         * @param {boolean} isError - 是否為錯誤訊息
         */
        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            toastMessage.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toastMessage.classList.remove('hidden');
            setTimeout(() => {
                toastMessage.classList.add('hidden');
            }, 3000);
        }
        
        /**
         * 獲取所有報修單/任務並呈現在表格中
         */
        async function fetchAdminReports() {
            try {
                const response = await fetch('/admin/reports');
                if (!response.ok) throw new Error('無法獲取列表');
                const reports = await response.json();
                
                tableBody.innerHTML = '';
                if (reports.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-8">目前沒有任何報修紀錄。</td></tr>`;
                    return;
                }

                reports.forEach(report => {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-white border-b hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-medium text-gray-900">#${report.id}</td>
                        <td class="px-6 py-4">${report.location}</td>
                        <td class="px-6 py-4 break-words">${report.problem_description}</td>
                        <td class="px-6 py-4">${report.reporter_name}</td>
                        <td class="px-6 py-4">
                            ${generateStatusHTML(report)}
                        </td>
                        <td class="px-6 py-4 text-center space-x-2">
                            ${generateActionButtonsHTML(report)}
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            } catch (error) {
                console.error('獲取錯誤:', error);
                showToast('無法載入資料', true);
            }
        }

        /**
         * 根據報修單狀態生成對應的 HTML
         * @param {object} report - 報修單物件
         */
        function generateStatusHTML(report) {
            if (report.is_task) {
                return `<div class="font-semibold text-blue-600">已發布為任務</div>
                        <div class="text-xs text-gray-500">學生人數: ${report.current_students} / ${report.required_students}</div>`;
            } else {
                return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-800">
                            ${report.status}
                        </span>`;
            }
        }

        /**
         * 根據報修單狀態生成對應的操作按鈕 HTML
         * @param {object} report - 報修單物件
         */
        function generateActionButtonsHTML(report) {
            let buttonsHTML = '';
            if (!report.is_task) {
                buttonsHTML += `<button onclick="openPublishModal(${report.id})" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-2 px-3 rounded-md transition">發布任務</button>`;
            }
            buttonsHTML += `<button onclick="deleteReport(${report.id})" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-2 px-3 rounded-md transition">刪除</button>`;
            return buttonsHTML;
        }

        /**
         * 開啟"發布任務"的 Modal
         * @param {number} reportId - 要發布的報修單 ID
         */
        window.openPublishModal = (reportId) => {
            reportIdInput.value = reportId;
            requiredStudentsInput.value = 1;
            publishModal.classList.remove('modal-hidden');
            publishModal.classList.add('modal-visible');
        }

        /**
         * 關閉"發布任務"的 Modal
         */
        function closePublishModal() {
            publishModal.classList.add('modal-hidden');
            publishModal.classList.remove('modal-visible');
        }

        // 綁定取消按鈕事件
        cancelPublishBtn.addEventListener('click', closePublishModal);

        /**
         * 處理"發布任務"表單的提交
         */
        publishForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const reportId = reportIdInput.value;
            const requiredStudents = parseInt(requiredStudentsInput.value, 10);

            if (requiredStudents <= 0) {
                showToast('學生人數必須大於 0', true);
                return;
            }

            try {
                const response = await fetch(`/admin/reports/${reportId}/publish`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ required_students: requiredStudents }),
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || '發布失敗');
                
                showToast('任務已成功發布！');
                closePublishModal();
                fetchAdminReports(); // 重新整理列表
            } catch (error) {
                console.error('發布錯誤:', error);
                showToast(`發布失敗: ${error.message}`, true);
            }
        });

        /**
         * 刪除一個報修單或任務
         * @param {number} reportId - 要刪除的項目 ID
         */
        window.deleteReport = async (reportId) => {
            if (!confirm(`您確定要刪除 ID 為 #${reportId} 的項目嗎？此操作無法復原。`)) {
                return;
            }
            try {
                const response = await fetch(`/admin/reports/${reportId}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.detail || '刪除失敗');
                }
                
                showToast(`ID #${reportId} 已成功刪除。`);
                fetchAdminReports(); // 重新整理列表
            } catch (error) {
                console.error('刪除錯誤:', error);
                showToast(`刪除失敗: ${error.message}`, true);
            }
        }
        
        // 頁面初次載入時，獲取所有資料
        fetchAdminReports();
    </script>
</body>
</html>

