<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>設備報修留言板</title>
    <!-- 載入 Tailwind CSS 樣式 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .modal {
            transition: visibility 0.2s, opacity 0.2s linear;
        }
        .modal.hidden {
            visibility: hidden;
            opacity: 0;
        }
        .modal:not(.hidden) {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="max-w-6xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4 text-center">設備報修留言板</h1>
        <p class="text-gray-600 mb-6 text-center">在這裡留下你的設備報修需求。</p>

        <!-- 顯示使用者 ID -->
        <div class="mb-4 text-sm text-center text-gray-500">
            你的使用者 ID: <span id="user-id" class="font-mono bg-gray-100 p-1 rounded">載入中...</span>
        </div>

        <!-- 新增報修表單 -->
        <div class="bg-gray-50 p-6 rounded-lg mb-8 border border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">新增報修</h2>
            <form id="repair-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="reporter_name" class="block text-sm font-medium text-gray-700">報修者姓名</label>
                        <input type="text" id="reporter_name" name="reporter_name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                    </div>
                    <div>
                        <label for="location" class="block text-sm font-medium text-gray-700">設備位置</label>
                        <input type="text" id="location" name="location" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                    </div>
                </div>
                <div>
                    <label for="problem_description" class="block text-sm font-medium text-gray-700">設備問題描述</label>
                    <textarea id="problem_description" name="problem_description" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2"></textarea>
                </div>
                <div>
                    <label for="teacher" class="block text-sm font-medium text-gray-700">協助老師</label>
                    <input type="text" id="teacher" name="teacher" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                </div>
                <button type="submit" id="submit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">提交報修</button>
            </form>
        </div>

        <!-- 報修紀錄列表 -->
        <div>
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">報修列表</h2>
            <div id="loading-spinner" class="text-center text-gray-500 my-8 hidden">
                <div class="animate-spin inline-block w-8 h-8 border-[3px] border-current border-t-transparent text-gray-400 rounded-full" role="status">
                    <span class="sr-only">載入中...</span>
                </div>
                <p>載入報修紀錄...</p>
            </div>
            <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-md">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">報修者姓名</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">設備位置</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">設備問題描述</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">協助老師</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">報修時間</th>
                            <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="records-table-body" class="text-gray-700">
                        <!-- 報修紀錄將會動態新增到這裡 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 編輯報修 Modal -->
    <div id="edit-modal" class="modal fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75 z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">編輯報修紀錄</h3>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                <div>
                    <label for="edit-reporter_name" class="block text-sm font-medium text-gray-700">報修者姓名</label>
                    <input type="text" id="edit-reporter_name" name="reporter_name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                </div>
                <div>
                    <label for="edit-location" class="block text-sm font-medium text-gray-700">設備位置</label>
                    <input type="text" id="edit-location" name="location" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                </div>
                <div>
                    <label for="edit-problem_description" class="block text-sm font-medium text-gray-700">設備問題描述</label>
                    <textarea id="edit-problem_description" name="problem_description" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2"></textarea>
                </div>
                <div>
                    <label for="edit-teacher" class="block text-sm font-medium text-gray-700">協助老師</label>
                    <input type="text" id="edit-teacher" name="teacher" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="edit-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md transition-colors duration-200">取消</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 刪除確認 Modal -->
    <div id="delete-modal" class="modal fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75 z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold mb-4">確定要刪除這筆紀錄嗎？</h3>
            <p class="text-gray-600 mb-6">此動作無法復原。</p>
            <div class="flex justify-center space-x-4">
                <button id="delete-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md transition-colors duration-200">取消</button>
                <button id="delete-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">刪除</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase 模組載入
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定 Firebase 偵錯等級
        setLogLevel('debug');

        // 全域變數，由環境自動提供
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        const form = document.getElementById('repair-form');
        const recordsTableBody = document.getElementById('records-table-body');
        const loadingSpinner = document.getElementById('loading-spinner');
        const userIdDisplay = document.getElementById('user-id');

        // Modal 元素
        const editModal = document.getElementById('edit-modal');
        const deleteModal = document.getElementById('delete-modal');
        const editForm = document.getElementById('edit-form');
        const editCancelBtn = document.getElementById('edit-cancel-btn');
        const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
        const deleteCancelBtn = document.getElementById('delete-cancel-btn');
        let recordToDeleteId = null;

        // Firebase 初始化與使用者驗證
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        // 監聽驗證狀態變化
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = userId;
                // 開始監聽資料庫
                startListeningForRecords();
            } else {
                // 匿名登入
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            }
        });

        // 提交表單處理
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                // 將資料新增到 Firestore 公開集合
                // 公開資料路徑: /artifacts/{appId}/public/data/{your_collection_name}
                const collectionPath = `/artifacts/${appId}/public/data/repair-requests`;
                await addDoc(collection(db, collectionPath), {
                    ...data,
                    userId: userId, // 紀錄提交者的使用者ID
                    timestamp: serverTimestamp()
                });
                form.reset();
            } catch (error) {
                console.error("提交報修紀錄時發生錯誤:", error);
                // 這裡可以顯示一個使用者友善的錯誤訊息
            }
        });

        // 監聽 Firestore 資料變化
        function startListeningForRecords() {
            if (!userId) {
                console.warn("使用者ID未定義，無法啟動資料監聽。");
                return;
            }

            loadingSpinner.classList.remove('hidden');

            const collectionPath = `/artifacts/${appId}/public/data/repair-requests`;
            const q = query(collection(db, collectionPath));
            
            onSnapshot(q, (snapshot) => {
                loadingSpinner.classList.add('hidden');
                recordsTableBody.innerHTML = ''; // 清空表格

                if (snapshot.empty) {
                    const noRecordsRow = `
                        <tr>
                            <td colspan="6" class="py-4 text-center text-gray-500">目前沒有任何報修紀錄。</td>
                        </tr>
                    `;
                    recordsTableBody.innerHTML = noRecordsRow;
                    return;
                }
                
                snapshot.forEach((doc) => {
                    const record = doc.data();
                    const recordId = doc.id;
                    const isOwner = record.userId === userId; // 檢查是否為本人
                    const timestamp = record.timestamp ? new Date(record.timestamp.toMillis()).toLocaleString() : 'N/A';
                    
                    const newRow = `
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="py-3 px-6 text-left whitespace-nowrap">${record.reporter_name}</td>
                            <td class="py-3 px-6 text-left">${record.location}</td>
                            <td class="py-3 px-6 text-left">${record.problem_description}</td>
                            <td class="py-3 px-6 text-left">${record.teacher}</td>
                            <td class="py-3 px-6 text-left">${timestamp}</td>
                            <td class="py-3 px-6 text-center whitespace-nowrap">
                                ${isOwner ? `
                                    <button onclick="window.editRecord('${recordId}')" class="text-blue-600 hover:text-blue-900 transition-colors duration-200 font-medium mr-4">編輯</button>
                                    <button onclick="window.deleteRecord('${recordId}')" class="text-red-600 hover:text-red-900 transition-colors duration-200 font-medium">刪除</button>
                                ` : `
                                    <span class="text-gray-400">無權操作</span>
                                `}
                            </td>
                        </tr>
                    `;
                    recordsTableBody.innerHTML += newRow;
                });
            }, (error) => {
                console.error("監聽報修紀錄時發生錯誤:", error);
                loadingSpinner.classList.add('hidden');
                recordsTableBody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-red-500">無法載入紀錄。</td></tr>`;
            });
        }

        // 處理刪除
        window.deleteRecord = (recordId) => {
            recordToDeleteId = recordId;
            deleteModal.classList.remove('hidden');
        };

        deleteConfirmBtn.addEventListener('click', async () => {
            if (recordToDeleteId) {
                try {
                    const collectionPath = `/artifacts/${appId}/public/data/repair-requests`;
                    await deleteDoc(doc(db, collectionPath, recordToDeleteId));
                    console.log("紀錄刪除成功:", recordToDeleteId);
                } catch (error) {
                    console.error("刪除紀錄時發生錯誤:", error);
                }
                recordToDeleteId = null;
                deleteModal.classList.add('hidden');
            }
        });
        
        deleteCancelBtn.addEventListener('click', () => {
            recordToDeleteId = null;
            deleteModal.classList.add('hidden');
        });

        // 處理編輯
        window.editRecord = async (recordId) => {
            try {
                const collectionPath = `/artifacts/${appId}/public/data/repair-requests`;
                const recordDoc = await getDoc(doc(db, collectionPath, recordId));
                if (recordDoc.exists()) {
                    const record = recordDoc.data();
                    document.getElementById('edit-id').value = recordId;
                    document.getElementById('edit-reporter_name').value = record.reporter_name;
                    document.getElementById('edit-location').value = record.location;
                    document.getElementById('edit-problem_description').value = record.problem_description;
                    document.getElementById('edit-teacher').value = record.teacher;
                    editModal.classList.remove('hidden');
                }
            } catch (error) {
                console.error("獲取紀錄資料時發生錯誤:", error);
            }
        };

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const recordId = document.getElementById('edit-id').value;
            const formData = new FormData(editForm);
            const data = Object.fromEntries(formData.entries());

            try {
                const collectionPath = `/artifacts/${appId}/public/data/repair-requests`;
                await updateDoc(doc(db, collectionPath, recordId), data);
                editModal.classList.add('hidden');
            } catch (error) {
                console.error("更新紀錄時發生錯誤:", error);
            }
        });

        editCancelBtn.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

    </script>
</body>
</html>
